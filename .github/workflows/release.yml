# CanvusLocalLLM Release Workflow
# Builds for Windows with CUDA support and creates installer
#
# Trigger: Push tags matching v* (e.g., v1.0.0)
# Outputs: Windows installer, executables, checksums

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: false
        default: 'dev'

env:
  GO_VERSION: '1.24'
  CUDA_VERSION: '12.4.0'

jobs:
  # =============================================================================
  # Windows Build Job
  # =============================================================================
  build-windows:
    name: Build Windows (CUDA)
    runs-on: windows-latest

    steps:
      # -------------------------------------------------------------------------
      # Setup
      # -------------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ github.event.inputs.version }}" -ne "dev") {
            $version = "${{ github.event.inputs.version }}"
          } elseif ("${{ github.ref_type }}" -eq "tag") {
            $version = "${{ github.ref_name }}" -replace '^v', ''
          } else {
            $version = "0.0.0-dev"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Building version: $version"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.18
        id: cuda-toolkit
        with:
          cuda: ${{ env.CUDA_VERSION }}
          method: 'network'
          sub-packages: '["nvcc", "cudart", "cublas", "cublas_dev"]'

      - name: Verify CUDA installation
        shell: pwsh
        run: |
          echo "CUDA_PATH: $env:CUDA_PATH"
          nvcc --version
          echo "CUDA Toolkit installed successfully"

      # -------------------------------------------------------------------------
      # Build llama.cpp with CUDA
      # -------------------------------------------------------------------------
      - name: Clone llama.cpp
        shell: pwsh
        run: |
          git clone --depth 1 https://github.com/ggerganov/llama.cpp.git deps/llama.cpp

      - name: Build llama.cpp (CUDA)
        shell: pwsh
        run: |
          cd deps/llama.cpp
          mkdir build
          cd build
          cmake .. `
            -DCMAKE_BUILD_TYPE=Release `
            -DLLAMA_CUDA=ON `
            -DLLAMA_CUBLAS=ON `
            -DLLAMA_NATIVE=OFF `
            -DLLAMA_BUILD_TESTS=OFF `
            -DLLAMA_BUILD_EXAMPLES=ON `
            -DLLAMA_BUILD_SERVER=ON
          cmake --build . --config Release -j $env:NUMBER_OF_PROCESSORS

          # List built artifacts
          echo "Built llama.cpp artifacts:"
          Get-ChildItem -Path . -Recurse -Include "*.dll","*.exe" | Select-Object FullName

      - name: Copy llama.cpp artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path lib

          # Copy DLLs
          Get-ChildItem -Path deps/llama.cpp/build -Recurse -Filter "*.dll" | ForEach-Object {
            Copy-Item $_.FullName -Destination lib/
            echo "Copied: $($_.Name)"
          }

          # Copy llama-server if exists
          $server = Get-ChildItem -Path deps/llama.cpp/build -Recurse -Filter "llama-server.exe" | Select-Object -First 1
          if ($server) {
            Copy-Item $server.FullName -Destination lib/
            echo "Copied: llama-server.exe"
          }

      # -------------------------------------------------------------------------
      # Build stable-diffusion.cpp with CUDA
      # -------------------------------------------------------------------------
      - name: Clone stable-diffusion.cpp
        shell: pwsh
        run: |
          git clone --recursive https://github.com/leejet/stable-diffusion.cpp.git deps/stable-diffusion.cpp

      - name: Build stable-diffusion.cpp (CUDA)
        shell: pwsh
        run: |
          cd deps/stable-diffusion.cpp
          mkdir build
          cd build
          cmake .. `
            -DCMAKE_BUILD_TYPE=Release `
            -DSD_CUBLAS=ON `
            -DBUILD_SHARED_LIBS=OFF
          cmake --build . --config Release -j $env:NUMBER_OF_PROCESSORS

          # List built artifacts
          echo "Built stable-diffusion.cpp artifacts:"
          Get-ChildItem -Path . -Recurse -Include "*.dll","*.exe","sd.exe" | Select-Object FullName

      - name: Copy stable-diffusion.cpp artifacts
        shell: pwsh
        run: |
          # Copy DLLs
          Get-ChildItem -Path deps/stable-diffusion.cpp/build -Recurse -Filter "*.dll" | ForEach-Object {
            Copy-Item $_.FullName -Destination lib/
            echo "Copied: $($_.Name)"
          }

          # Copy sd executable if exists
          $sd = Get-ChildItem -Path deps/stable-diffusion.cpp/build -Recurse -Filter "sd.exe" | Select-Object -First 1
          if ($sd) {
            Copy-Item $sd.FullName -Destination lib/
            echo "Copied: sd.exe"
          }

      # -------------------------------------------------------------------------
      # Build Go Application
      # -------------------------------------------------------------------------
      - name: Build Go application
        shell: pwsh
        env:
          CGO_ENABLED: 0
          GOOS: windows
          GOARCH: amd64
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"

          # Create bin directory for output
          New-Item -ItemType Directory -Force -Path bin

          # Build with version injection
          go build -v `
            -ldflags "-s -w -X main.Version=$version" `
            -o bin/CanvusLocalLLM.exe `
            .

          echo "Built: bin/CanvusLocalLLM.exe"
          Get-Item bin/CanvusLocalLLM.exe | Select-Object Name, Length

      - name: Run Go tests
        shell: pwsh
        run: |
          go test -v -race -timeout 300s ./...

      # -------------------------------------------------------------------------
      # Build NSIS Installer
      # -------------------------------------------------------------------------
      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y
          echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH

      - name: Prepare installer files
        shell: pwsh
        run: |
          # Verify bin directory has executable
          if (-not (Test-Path "bin/CanvusLocalLLM.exe")) {
            Write-Error "CanvusLocalLLM.exe not found in bin/"
            exit 1
          }

          # Ensure example.env exists
          if (-not (Test-Path "example.env")) {
            Write-Error "example.env not found"
            exit 1
          }

          # List files for installer
          echo "Files for installer:"
          Get-ChildItem -Path bin/
          Get-ChildItem -Path lib/

      - name: Build NSIS Installer
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"

          cd installer/windows

          # Build installer with version
          makensis /DPRODUCT_VERSION=$version setup.nsi

          # Rename output to include version
          $installerName = "CanvusLocalLLM-$version-Setup.exe"
          if (Test-Path "CanvusLocalLLM-0.1.0-Setup.exe") {
            Rename-Item "CanvusLocalLLM-0.1.0-Setup.exe" $installerName
          }

          echo "Built installer: $installerName"
          Get-ChildItem -Filter "*.exe"

          # Move to dist directory
          New-Item -ItemType Directory -Force -Path ../../dist
          Move-Item "CanvusLocalLLM-*-Setup.exe" ../../dist/

      # -------------------------------------------------------------------------
      # Generate Checksums and Upload
      # -------------------------------------------------------------------------
      - name: Generate checksums
        shell: pwsh
        run: |
          cd dist

          # Generate SHA256 checksums
          Get-ChildItem -Filter "*.exe" | ForEach-Object {
            $hash = (Get-FileHash -Path $_.FullName -Algorithm SHA256).Hash.ToLower()
            "$hash  $($_.Name)" | Out-File -Append -FilePath "checksums-windows.txt" -Encoding ASCII
            echo "$hash  $($_.Name)"
          }

          # Also add standalone exe
          Copy-Item ../bin/CanvusLocalLLM.exe .
          $hash = (Get-FileHash -Path "CanvusLocalLLM.exe" -Algorithm SHA256).Hash.ToLower()
          "$hash  CanvusLocalLLM.exe" | Out-File -Append -FilePath "checksums-windows.txt" -Encoding ASCII

          echo ""
          echo "Checksums:"
          Get-Content checksums-windows.txt

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            dist/*.exe
            dist/checksums-windows.txt
          if-no-files-found: error
          retention-days: 30

      - name: Upload Windows lib artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-libs
          path: |
            lib/*.dll
            lib/*.exe
          if-no-files-found: warn
          retention-days: 30

  # =============================================================================
  # Linux Build Job
  # =============================================================================
  build-linux:
    name: Build Linux (CUDA)
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------------------------
      # Setup
      # -------------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "dev" ]]; then
            version="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            version="${{ github.ref_name }}"
            version="${version#v}"
          else
            version="0.0.0-dev"
          fi
          echo "VERSION=$version" >> $GITHUB_OUTPUT
          echo "Building version: $version"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.18
        id: cuda-toolkit
        with:
          cuda: ${{ env.CUDA_VERSION }}
          method: 'network'
          linux-local-args: '["--toolkit"]'

      - name: Verify CUDA installation
        shell: bash
        run: |
          echo "CUDA_PATH: $CUDA_PATH"
          nvcc --version
          echo "CUDA Toolkit installed successfully"

      # -------------------------------------------------------------------------
      # Build llama.cpp with CUDA
      # -------------------------------------------------------------------------
      - name: Build llama.cpp (CUDA)
        shell: bash
        run: |
          chmod +x scripts/build-llamacpp-cuda.sh
          ./scripts/build-llamacpp-cuda.sh --jobs $(nproc)

          # List built artifacts
          echo "Built llama.cpp artifacts:"
          find deps/llama.cpp/build -type f \( -name "*.so" -o -name "llama-server" -o -name "server" \) -exec ls -lh {} \;

      # -------------------------------------------------------------------------
      # Build stable-diffusion.cpp with CUDA
      # -------------------------------------------------------------------------
      - name: Build stable-diffusion.cpp (CUDA)
        shell: bash
        run: |
          chmod +x scripts/build-sd-cuda.sh
          ./scripts/build-sd-cuda.sh --jobs $(nproc)

          # List built artifacts
          echo "Built stable-diffusion.cpp artifacts:"
          find deps/stable-diffusion.cpp/build -type f \( -name "*.so" -o -name "sd" \) -exec ls -lh {} \;

      # -------------------------------------------------------------------------
      # Build Go Application
      # -------------------------------------------------------------------------
      - name: Build Go application
        shell: bash
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          version="${{ steps.version.outputs.VERSION }}"

          # Build with version injection
          go build -v \
            -ldflags "-s -w -X main.Version=$version" \
            -o canvuslocallm \
            .

          echo "Built: canvuslocallm"
          ls -lh canvuslocallm

      - name: Run Go tests
        shell: bash
        run: |
          go test -v -race -timeout 300s ./...

      # -------------------------------------------------------------------------
      # Build Debian Package
      # -------------------------------------------------------------------------
      - name: Build .deb package
        shell: bash
        run: |
          version="${{ steps.version.outputs.VERSION }}"

          chmod +x scripts/build-deb.sh
          ./scripts/build-deb.sh --version "$version" --output dist --skip-build

          echo "Built .deb package:"
          ls -lh dist/*.deb

      # -------------------------------------------------------------------------
      # Build Tarball
      # -------------------------------------------------------------------------
      - name: Build tarball
        shell: bash
        run: |
          version="${{ steps.version.outputs.VERSION }}"

          chmod +x scripts/build-tarball.sh
          ./scripts/build-tarball.sh --version "$version" --output dist --skip-build

          echo "Built tarball:"
          ls -lh dist/*.tar.gz

      # -------------------------------------------------------------------------
      # Generate Checksums and Upload
      # -------------------------------------------------------------------------
      - name: Generate checksums
        shell: bash
        run: |
          cd dist

          # Generate SHA256 checksums for all artifacts
          for file in *.deb *.tar.gz; do
            if [[ -f "$file" ]]; then
              sha256sum "$file" >> checksums-linux.txt
              echo "Generated checksum for: $file"
            fi
          done

          echo ""
          echo "Checksums:"
          cat checksums-linux.txt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: |
            dist/*.deb
            dist/*.tar.gz
            dist/checksums-linux.txt
          if-no-files-found: error
          retention-days: 30

      - name: Upload Linux lib artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-libs
          path: |
            deps/llama.cpp/build/**/*.so
            deps/llama.cpp/build/**/llama-server
            deps/stable-diffusion.cpp/build/**/*.so
            deps/stable-diffusion.cpp/build/**/sd
          if-no-files-found: warn
          retention-days: 30

  # =============================================================================
  # Release Job
  # =============================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      # -------------------------------------------------------------------------
      # Setup
      # -------------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            version="${{ github.ref_name }}"
            version="${version#v}"
          else
            version="0.0.0-dev"
          fi
          echo "VERSION=$version" >> $GITHUB_OUTPUT
          echo "Release version: $version"

      # -------------------------------------------------------------------------
      # Download Artifacts
      # -------------------------------------------------------------------------
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: artifacts/windows

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-release
          path: artifacts/linux

      # -------------------------------------------------------------------------
      # Merge Checksums
      # -------------------------------------------------------------------------
      - name: Merge checksums
        shell: bash
        run: |
          mkdir -p release-assets

          # Copy all release artifacts
          cp artifacts/windows/*.exe release-assets/
          cp artifacts/linux/*.deb release-assets/
          cp artifacts/linux/*.tar.gz release-assets/

          # Merge checksums
          cd release-assets
          cat ../artifacts/windows/checksums-windows.txt > checksums.txt
          cat ../artifacts/linux/checksums-linux.txt >> checksums.txt

          echo "Merged checksums:"
          cat checksums.txt

          # List all release assets
          echo ""
          echo "Release assets:"
          ls -lh

      # -------------------------------------------------------------------------
      # Generate Release Notes
      # -------------------------------------------------------------------------
      - name: Generate release notes
        id: release_notes
        shell: bash
        run: |
          version="${{ steps.version.outputs.VERSION }}"

          # Get the previous tag
          prev_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate changelog
          if [[ -n "$prev_tag" ]]; then
            echo "# What's Changed" > release-notes.md
            echo "" >> release-notes.md
            git log ${prev_tag}..HEAD --pretty=format:"- %s (%h)" --reverse >> release-notes.md
            echo "" >> release-notes.md
            echo "" >> release-notes.md
          else
            echo "# Initial Release" > release-notes.md
            echo "" >> release-notes.md
          fi

          # Add download instructions
          cat >> release-notes.md << 'EOF'
          ## Download & Installation

          ### Windows
          - **Installer**: Download `CanvusLocalLLM-{version}-Setup.exe` for automatic installation
          - **Standalone**: Download `CanvusLocalLLM.exe` to run without installation

          ### Linux
          - **Debian/Ubuntu**: Download `canvuslocallm_{version}_amd64.deb` and install with `sudo dpkg -i canvuslocallm_{version}_amd64.deb`
          - **Other distributions**: Download `canvuslocallm-{version}-linux-amd64.tar.gz` and extract

          ## Requirements
          - NVIDIA GPU with CUDA support (for GPU acceleration)
          - Canvus account and API key

          ## Verification
          Verify your download using the SHA256 checksums in `checksums.txt`:
          ```bash
          sha256sum -c checksums.txt
          ```

          ## Documentation
          See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for setup and usage instructions.
          EOF

          # Replace {version} placeholders
          sed -i "s/{version}/${version}/g" release-notes.md

          echo "Generated release notes:"
          cat release-notes.md

      # -------------------------------------------------------------------------
      # Create GitHub Release
      # -------------------------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "v${{ steps.version.outputs.VERSION }}"
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'rc') }}
          files: |
            release-assets/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
