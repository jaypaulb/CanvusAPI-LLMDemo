#!/bin/bash
# Post-removal script for canvuslocallm
set -e

INSTALL_DIR="/opt/canvuslocallm"
SERVICE_USER="canvusllm"
SERVICE_GROUP="canvusllm"
SERVICE_NAME="canvuslocallm"
LD_CONF_FILE="/etc/ld.so.conf.d/canvuslocallm.conf"

case "$1" in
    purge)
        # Remove systemd service file
        if [ -f "/etc/systemd/system/$SERVICE_NAME.service" ]; then
            rm -f "/etc/systemd/system/$SERVICE_NAME.service"
            echo "Removed systemd service file"
        fi

        # Reload systemd daemon
        systemctl daemon-reload

        # Remove ld.so.conf.d entry
        if [ -f "$LD_CONF_FILE" ]; then
            rm -f "$LD_CONF_FILE"
            ldconfig
            echo "Removed library configuration"
        fi

        # Remove installation directory (including lib/ and models/)
        if [ -d "$INSTALL_DIR" ]; then
            # Warn about large model files before removal
            if [ -d "$INSTALL_DIR/models" ]; then
                MODEL_SIZE=$(du -sh "$INSTALL_DIR/models" 2>/dev/null | cut -f1)
                echo "Removing models directory ($MODEL_SIZE)..."
            fi
            rm -rf "$INSTALL_DIR"
            echo "Removed installation directory: $INSTALL_DIR"
        fi

        # Remove service user
        if getent passwd "$SERVICE_USER" > /dev/null 2>&1; then
            userdel "$SERVICE_USER" 2>/dev/null || true
            echo "Removed system user: $SERVICE_USER"
        fi

        # Remove service group
        if getent group "$SERVICE_GROUP" > /dev/null 2>&1; then
            groupdel "$SERVICE_GROUP" 2>/dev/null || true
            echo "Removed system group: $SERVICE_GROUP"
        fi

        echo "CanvusLocalLLM has been completely removed."
        ;;

    remove)
        # Remove systemd service file
        if [ -f "/etc/systemd/system/$SERVICE_NAME.service" ]; then
            rm -f "/etc/systemd/system/$SERVICE_NAME.service"
            echo "Removed systemd service file"
        fi

        # Reload systemd daemon
        systemctl daemon-reload

        # Remove ld.so.conf.d entry
        if [ -f "$LD_CONF_FILE" ]; then
            rm -f "$LD_CONF_FILE"
            ldconfig
            echo "Removed library configuration"
        fi

        # Note: On remove (not purge), we keep:
        # - /opt/canvuslocallm/.env (user configuration)
        # - /opt/canvuslocallm/models/ (large downloaded models)
        # - Service user and group (for reinstall)
        echo ""
        echo "Note: Configuration and models preserved in $INSTALL_DIR"
        echo "      Use 'apt purge canvuslocallm' to remove completely."
        ;;

    upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        # Nothing to do
        ;;

    *)
        echo "postrm called with unknown argument: $1" >&2
        exit 1
        ;;
esac

exit 0
